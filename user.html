<!DOCTYPE html>
<html lang="en">
    <head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta http-equiv="X-UA-Compatible" content="ie=edge">
		<title>Document</title>
		
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
		<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.2.11/web3.min.js" integrity="sha512-6lf28FmolQdo4ap44cXw7j+thYEZzS1/kXxDkX1ppO//SHCageBS1HmYdqkkL819WfGtQ+7TE+uXEwsxjJXEKQ==" crossorigin="anonymous"></script> -->
		
</script>
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
		<link rel="stylesheet" type="text/css" href="index.css">
    </head>
	
    <body > 
		<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
			<a class="navbar-brand" href="#">Rewards Hub</a>
			<button class="navbar-toggler" type="button" data-toggle="collapse" 
			data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" 
			aria-expanded="false" aria-label="Toggle navigation">
			  <span class="navbar-toggler-icon"></span>
			</button>
		  
			<div class="collapse navbar-collapse" id="navbarSupportedContent">
			  <ul class="navbar-nav mr-auto">
				<li class="nav-item ">
				  <a class="nav-link" href="admin.html">Admin </a>
				</li>
				<li class="nav-item active">
				  <a class="nav-link" href="user.html">User <span class="sr-only">(current)</span></a>
				</li>
			  </ul>
			</div>
			<div id="prepare">
				<button class="btn btn-primary" id="btn-connect">
				  Connect wallet
				</button>
			  </div>
	
			  <div id="connected" style="display: none">	
				<button class="btn btn-primary" id="btn-disconnect">
				  Disconnect wallet
				</button>	
			  </div>
			<div id="selected-account"></div> 
		  </nav>
		  <div class="container">
		  <div class="row">
			<h1 class="col-md-12 text-center"> REWARDS HUB USER FLOW </h1>
			<div class="col-md-12">					
					<h3 class="row col-lg-12" >REDEEM TOKEN</h3><div>
					<div class="form-group row col-lg-12">
						<input class="col-lg-4 form-control" id="points" type="text" placeholder="Points to redeem"/>
						<input class="col-lg-4 form-control" id="redeem-token" type="text" placeholder="Tokens to redeem"/>
						<button class="col-lg-2 btn btn-dark" id="redeem-btn">Redeem</button></div>  
						<div class="alert alert-dark redeem-success" role="alert"></div>			
					</div>
					
					<h3 class="row col-lg-12" >TOKEN BALANCE : <span class="user-bal"></span> MIXS </h3><div>
					
	
	
			</div>
		  </div>	
		</div>
</body>
	<script>
		$(document).ready(function() {
			$(".pool-success").hide(); $(".redeem-success").hide(); $(".tx-success").hide();
		});
	</script>
	<script type="text/javascript" src="https://unpkg.com/web3@1.2.11/dist/web3.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/web3modal@1.9.0/dist/index.js"></script>
    <script type="text/javascript" src="https://unpkg.com/evm-chains@0.2.0/dist/umd/index.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/@walletconnect/web3-provider@1.2.1/dist/umd/index.min.js"></script>
	<script type="text/javascript" src="https://unpkg.com/fortmatic@2.0.6/dist/fortmatic.js"></script>
	<!-- This is our example code -->
	<script type="text/javascript" src="./example.js"></script>
	
	<script type="module">
		import { ethers } from "https://cdn.ethers.io/lib/ethers-5.0.esm.min.js";
		const provider = new ethers.providers.Web3Provider(window.ethereum)
		const signer = provider.getSigner()
		
		// contract details
		var rewardMgmtABI= JSON.parse('[{"inputs":[{"internalType":"uint256","name":"poolTokens","type":"uint256"}],"name":"createPool","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenToRedeem","type":"uint256"}],"name":"redeemToken","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"ratio","type":"uint256"}],"name":"setConversionRatio","outputs":[{"internalType":"bool","name":"success","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"setDayLimit","outputs":[{"internalType":"bool","name":"success","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"setTranLimit","outputs":[{"internalType":"bool","name":"success","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[],"name":"conversionRatio","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"maxDayToken","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"maxTransToken","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"ownerBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"poolBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"userBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}]');
		const rewardMgmtContract = new ethers.Contract('0x8B956ff88257622e2319f423Dadc9EcBc095F70e', rewardMgmtABI, provider);
		const rewardMgmtSigner = rewardMgmtContract.connect(signer);	
		
		getTokenBalance();
		var conversionRatio;

		$(document).on("click", "#redeem-btn", async function(){
			var token = $("#redeem-token").val();
			// var wei = parseInt(token)*1e18;
			console.log("token: "+ token);
		
			await rewardMgmtSigner.redeemToken(token).then(async function(tx){
				$(".redeem-success").text(tx.hash);
				console.log("Transaction hash : " + tx.hash);	
				setTimeout(await function(){dispResult(token, tx.hash); }, 5000);		
				
			});	
		});

		async function dispResult(token, hash) {
				console.log(token);
				console.log(hash);
				provider.getTransactionReceipt(hash).then(async function(receipt) {
					console.log("Transaction Receipt: " +receipt);
					if(receipt) {
						if(receipt.status == 1) {
						console.log("success");					
							$(".redeem-success").text("Successfully redeemed "+ token +" token .");
							$(".redeem-success").show();
						} else {
							console.log("fail");					
							$(".redeem-success").text("Txion failed");
							$(".redeem-success").show();
						}
					} else {
						setTimeout(await function(){dispResult(token, hash); }, 5000);
					
					}
				});		
			}


		$(document).on("change", "#redeem-token", async function(){
			var token = $("#redeem-token").val();			
			// var wei = parseInt(token)*1e18;
			var points = parseInt(( token / conversionRatio)*100);
			$("#points").val(points);
			console.log("points : " + points);
		});
		$(document).on("change", "#points", async function(){
			var points = $("#points").val();			
			// var wei = parseInt(token)*1e18;
			var token = parseInt(( points * conversionRatio)/100);
			$("#redeem-token").val(token);
			console.log("Token : " + token);			
		});

		async function getTokenBalance() {
			const userBalance = await rewardMgmtSigner.userBalance();
			$(".user-bal").text(userBalance);
			console.log("userBalance : " + userBalance);

			const cr = await rewardMgmtSigner.conversionRatio();
			console.log("conversionRatio : " + cr);
			conversionRatio = cr;
		}
		
	</script>
</html>